<template>
  <v-card class="mt-4">
    <v-card-title>
      Статистика приоритетов
      <v-chip class="ml-2" color="info" small>
        Учтено: {{ usersWithMotivations.length }} пользователей
      </v-chip>
    </v-card-title>
    
    <v-card-text>
      <v-alert v-if="chartError" type="error" class="mb-4">
        Ошибка при создании диаграмм: {{ chartError }}
      </v-alert>
      
      <v-progress-linear
        v-if="loading"
        indeterminate
        color="primary"
      ></v-progress-linear>
      
      <template v-else>
        <!-- Контейнеры для диаграмм с явными размерами -->
        <v-row class="chart-container">
          <v-col md="12">
            <div 
              ref="pieChart" 
              class="chart"
              :style="{ height: chartHeight + 'px' }"
            ></div>
            <div class="text-center mt-2">Распределение мотиваций (взвешенные баллы)</div>
          </v-col>
        </v-row>

        <!-- Таблица с расшифровкой мотиваций -->
        <v-row class="mt-6">
          <v-col cols="12">
            <v-card>
              <v-card-title>
                <v-icon class="mr-2">mdi-information</v-icon>
                Расшифровка мотиваций и рекомендации
              </v-card-title>
              <v-card-text>
                <v-tabs v-model="motivationTab" grow>
                  <v-tab value="details">Детали мотиваций</v-tab>
                  <v-tab value="employee">Рекомендации для сотрудников</v-tab>
                  <v-tab value="team">Рекомендации для коллектива</v-tab>
                </v-tabs>

                <v-window v-model="motivationTab">
                  <!-- Детали мотиваций -->
                  <v-window-item value="details">
                    <v-data-table
                      :headers="motivationHeaders"
                      :items="motivationDetails"
                      :items-per-page="10"
                      class="elevation-1 mt-4"
                    >
                      <template v-slot:item.description="{ item }">
                        <div class="text-caption">{{ item.description }}</div>
                      </template>
                      <template v-slot:item.pros="{ item }">
                        <ul class="pl-3 mb-0">
                          <li v-for="(pro, index) in item.pros" :key="index" class="text-caption">
                            {{ pro }}
                          </li>
                        </ul>
                      </template>
                      <template v-slot:item.cons="{ item }">
                        <ul class="pl-3 mb-0">
                          <li v-for="(con, index) in item.cons" :key="index" class="text-caption">
                            {{ con }}
                          </li>
                        </ul>
                      </template>
                    </v-data-table>
                  </v-window-item>

                  <!-- Рекомендации для сотрудников -->
                  <v-window-item value="employee">
                    <v-data-table
                      :headers="employeeHeaders"
                      :items="employeeRecommendations"
                      :items-per-page="10"
                      class="elevation-1 mt-4"
                    >
                      <template v-slot:item.recommendations="{ item }">
                        <ul class="pl-3 mb-0">
                          <li v-for="(rec, index) in item.recommendations" :key="index" class="text-caption">
                            {{ rec }}
                          </li>
                        </ul>
                      </template>
                    </v-data-table>
                  </v-window-item>

                  <!-- Рекомендации для коллектива -->
                  <v-window-item value="team">
                    <v-data-table
                      :headers="teamHeaders"
                      :items="teamRecommendations"
                      :items-per-page="10"
                      class="elevation-1 mt-4"
                    >
                      <template v-slot:item.recommendations="{ item }">
                        <ul class="pl-3 mb-0">
                          <li v-for="(rec, index) in item.recommendations" :key="index" class="text-caption">
                            {{ rec }}
                          </li>
                        </ul>
                      </template>
                    </v-data-table>
                  </v-window-item>
                </v-window>
              </v-card-text>
            </v-card>
          </v-col>
        </v-row>

        <!-- Сводные рекомендации -->
        <v-row class="mt-4">
          <v-col cols="12">
            <v-card>
              <v-card-title>
                <v-icon class="mr-2">mdi-lightbulb-on</v-icon>
                Сводные рекомендации для компании
              </v-card-title>
              <v-card-text>
                <v-alert type="info" class="mb-4">
                  На основе топ-5 мотиваций сотрудников
                </v-alert>
                
                <v-row>
                  <v-col md="6">
                    <v-card color="blue-lighten-5">
                      <v-card-title class="text-h6">Для сотрудников</v-card-title>
                      <v-card-text>
                        <ul>
                          <li v-for="(rec, index) in topEmployeeRecommendations" :key="index" class="mb-2">
                            {{ rec }}
                          </li>
                        </ul>
                      </v-card-text>
                    </v-card>
                  </v-col>
                  
                  <v-col md="6">
                    <v-card color="green-lighten-5">
                      <v-card-title class="text-h6">Для коллектива</v-card-title>
                      <v-card-text>
                        <ul>
                          <li v-for="(rec, index) in topTeamRecommendations" :key="index" class="mb-2">
                            {{ rec }}
                          </li>
                        </ul>
                      </v-card-text>
                    </v-card>
                  </v-col>
                </v-row>
              </v-card-text>
            </v-card>
          </v-col>
        </v-row>
      </template>
    </v-card-text>
  </v-card>
</template>

<script>
import * as echarts from 'echarts';

export default {
  props: {
    users: {
      type: Array,
      default: () => [],
      required: true
    },
    loading: {
      type: Boolean,
      default: false
    }
  },
  
  data: () => ({
    pieChart: null,
    chartError: null,
    chartHeight: 400,
    resizeObserver: null,
    motivationTab: 'details',
    
    motivationHeaders: [
      { title: 'Мотивация', value: 'name' },
      { title: 'Описание', value: 'description' },
      { title: 'Плюсы', value: 'pros' },
      { title: 'Минусы', value: 'cons' },
      { title: 'Баллы', value: 'score', align: 'center' }
    ],
    
    employeeHeaders: [
      { title: 'Мотивация', value: 'name' },
      { title: 'Рекомендации для сотрудника', value: 'recommendations' },
      { title: 'Баллы', value: 'score', align: 'center' }
    ],
    
    teamHeaders: [
      { title: 'Мотивация', value: 'name' },
      { title: 'Рекомендации для коллектива', value: 'recommendations' },
      { title: 'Баллы', value: 'score', align: 'center' }
    ],
    
    motivationDefinitions: {
      'Финансовые мотивы': {
        description: 'Материальное вознаграждение, бонусы, премии',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Общественное признание': {
        description: 'Признание достижений публично, награды, похвала',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Отношение с руководством': {
        description: 'Качество взаимоотношений с непосредственным руководителем',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Карьера, продвижение по службе': {
        description: 'Возможности карьерного роста и продвижения',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Достижение личного успеха': {
        description: 'Возможность достигать личных целей и успехов',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компании'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Содержание работы': {
        description: 'Интересность и содержательность рабочих задач',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Сотрудничество в коллективе': {
        description: 'Качество взаимодействия с коллегами',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Крутые цели компании': {
        description: 'Интересные и амбициозные цели организации',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Имидж компании': {
        description: 'Репутация и образ компании на рынке',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Престиж профессии': {
        description: 'Статус и престижность профессии',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Белая зарплата': {
        description: 'Официальное оформление заработной платы',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Комфортная атмосфера в коллективе': {
        description: 'Психологический климат в коллективе',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Возможность обучения': {
        description: 'Доступ к обучению и развитию навыков',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Возможность профессионального роста': {
        description: 'Перспективы профессионального развития',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Масштабные интересные задачи': {
        description: 'Крупные и увлекательные проекты',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Гибкий график': {
        description: 'Гибкость рабочего времени',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Возможность удалённой работы': {
        description: 'Работа из любого места',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Близость работы': {
        description: 'Удобное расположение рабочего места',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Современный офис': {
        description: 'Качество и современность офисного пространства',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Tребует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Удовольствие от процесса работы': {
        description: 'Получение удовольствия от рабочего процесса',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Обеспеченность оргтехникой / рабочее место': {
        description: 'Оснащенность рабочего места техникой',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Самостоятельность в работе': {
        description: 'Степень автономности в принятии решений',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Разнообразие работы': {
        description: 'Разнообразие задач и видов деятельности',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Низкая напряжённость труда': {
        description: 'Уровень стресса и напряженности на работе',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Возможность участия в управлении': {
        description: 'Участие в принятии управленческих решений',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Pоказывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      },
      'Другое': {
        description: 'Иные индивидуальные мотивационные факторы',
        pros: ['Повышает вовлечённость', 'Стимулирует развитие и активность', 'Укрепляет связь с компанией'],
        cons: ['Может вызвать трудности при неправильной реализации', 'Не всегда подходит для всех сотрудников', 'Требует внимания и ресурсов со стороны руководства'],
        employee: ['Давать задачи, усиливающие мотивацию', 'Показывать перспективы и возможности', 'Обсуждать развитие и успехи'],
        team: ['Создавать общие правила и возможности', 'Поощрять совместные достижения', 'Встраивать мотивацию в культуру компании']
      }
    }
  }),
  
  computed: {
    usersWithMotivations() {
      return this.users.filter(user => user.motivations?.length > 0);
    },
    
    motivationData() {
      const stats = {};
      
      this.usersWithMotivations.forEach(user => {
        user.motivations.forEach((motivation, index) => {
          const weight = 3 - index; // Вес по приоритету
          if (!stats[motivation.text]) {
            stats[motivation.text] = 0;
          }
          stats[motivation.text] += weight;
        });
      });
      
      return Object.entries(stats)
        .sort((a, b) => b[1] - a[1])
        .map(([name, value]) => ({ name, value }));
    },

    motivationDetails() {
      return this.motivationData.map(item => {
        const definition = this.motivationDefinitions[item.name] || {
          description: 'Описание недоступно',
          pros: ['Информация отсутствует'],
          cons: ['Информация отсутствует']
        };
        
        return {
          name: item.name,
          description: definition.description,
          pros: definition.pros,
          cons: definition.cons,
          score: item.value
        };
      });
    },

    employeeRecommendations() {
      return this.motivationData.map(item => {
        const definition = this.motivationDefinitions[item.name] || {
          employee: ['Рекомендации отсутствуют']
        };
        
        return {
          name: item.name,
          recommendations: definition.employee,
          score: item.value
        };
      });
    },

    teamRecommendations() {
      return this.motivationData.map(item => {
        const definition = this.motivationDefinitions[item.name] || {
          team: ['Рекомендации отсутствуют']
        };
        
        return {
          name: item.name,
          recommendations: definition.team,
          score: item.value
        };
      });
    },

    topEmployeeRecommendations() {
      const topMotivations = this.motivationData.slice(0, 5);
      const recommendations = new Set();
      
      topMotivations.forEach(item => {
        const definition = this.motivationDefinitions[item.name];
        if (definition && definition.employee) {
          definition.employee.forEach(rec => recommendations.add(rec));
        }
      });
      
      return Array.from(recommendations);
    },

    topTeamRecommendations() {
      const topMotivations = this.motivationData.slice(0, 5);
      const recommendations = new Set();
      
      topMotivations.forEach(item => {
        const definition = this.motivationDefinitions[item.name];
        if (definition && definition.team) {
          definition.team.forEach(rec => recommendations.add(rec));
        }
      });
      
      return Array.from(recommendations);
    }
  },
  
  methods: {
    initCharts() {
      try {
        if (!this.motivationData.length) {
          this.chartError = "Нет данных для построения диаграмм";
          return;
        }
        
        this.chartError = null;
        
        if (this.$refs.pieChart) {
          this.initPieChart();
        }
        
      } catch (error) {
        this.chartError = error.message;
        console.error("Ошибка инициализации диаграмм:", error);
      }
    },
    
    initPieChart() {
      if (this.pieChart) {
        this.pieChart.dispose();
      }
      
      this.pieChart = echarts.init(this.$refs.pieChart);
      
      const option = {
        tooltip: {
          trigger: 'item',
          formatter: (params) => {
            const definition = this.motivationDefinitions[params.name] || {};
            return `
              <strong>${params.name}</strong><br/>
              Баллы: ${params.value} (${params.percent}%)<br/>
              <small>${definition.description || ''}</small>
            `;
          }
        },
        legend: {
          orient: 'vertical',
          right: 10,
          top: 'center',
          type: 'scroll',
          textStyle: {
            fontSize: 10
          }
        },
        series: [{
          name: 'Мотивации',
          type: 'pie',
          radius: ['30%', '70%'],
          center: ['40%', '50%'],
          data: this.motivationData,
          label: {
            show: true,
            formatter: '{b}: {c}'
          },
          emphasis: {
            itemStyle: {
              shadowBlur: 10,
              shadowOffsetX: 0,
              shadowColor: 'rgba(0, 0, 0, 0.5)'
            }
          }
        }]
      };
      
      this.pieChart.setOption(option);
    },
    
    handleResize() {
      try {
        if (this.pieChart) {
          this.pieChart.resize();
        }
      } catch (error) {
        console.error("Ошибка при ресайзе диаграмм:", error);
      }
    },
    
    observeResize() {
      if (this.resizeObserver) {
        this.resizeObserver.disconnect();
      }
      
      this.resizeObserver = new ResizeObserver(() => {
        this.handleResize();
      });
      
      if (this.$refs.pieChart) {
        this.resizeObserver.observe(this.$refs.pieChart);
      }
    }
  },
  
  watch: {
    users: {
      handler() {
        if (!this.loading) {
          this.$nextTick(() => {
            this.initCharts();
            this.observeResize();
          });
        }
      },
      deep: true
    },
    loading(newVal) {
      if (!newVal) {
        this.$nextTick(() => {
          this.initCharts();
          this.observeResize();
        });
      }
    }
  },
  
  mounted() {
    window.addEventListener('resize', this.handleResize);
    if (!this.loading) {
      this.$nextTick(() => {
        this.initCharts();
        this.observeResize();
      });
    }
  },
  
  beforeUnmount() {
    window.removeEventListener('resize', this.handleResize);
    if (this.resizeObserver) {
      this.resizeObserver.disconnect();
    }
    if (this.pieChart) {
      this.pieChart.dispose();
    }
  }
};
</script>

<style scoped>
.chart-container {
  margin-top: 20px;
}

.chart {
  width: 100%;
  min-height: 300px;
}

@media (max-width: 960px) {
  .chart {
    height: 300px !important;
  }
}

.text-caption {
  font-size: 0.75rem;
  line-height: 1.2;
}

.v-data-table {
  font-size: 0.8rem;
}
</style>